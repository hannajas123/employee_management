<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <h2 class="mb-4 text-center text-primary">Employee Management</h2>

  <div class="d-flex justify-content-between mb-3">
    <div>
      <input type="text" id="search-term" class="form-control" placeholder="Search by name, phone, etc.">
    </div>
    <button class="btn btn-success" id="add-employee">‚ûï Add Employee</button>
  </div>

  <table class="table table-bordered table-striped">
    <thead class="table-secondary">
      <tr>
        <th>#</th>
        <th>Form</th>
        <th>Data</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="employee-table"></tbody>
  </table>
</div>

 Modal -->
<!-- <div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalLabel">Add Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Select Form</label>
          <select id="form-select" class="form-select"></select>
        </div>
        <div id="dynamic-fields"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="save-employee">Save Employee</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/employee.js"></script>
</body>
</html>  --> 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

<!-- üåê Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="/form-builder/">Employee System</a>
    <div class="navbar-nav ms-auto">
         <a class="nav-link" href="/form-builder/">Form Builder</a>

      <a class="nav-link" href="/employees/">Employees</a>
      <a class="nav-link" href="/change-password/">Change Password</a>
      <a class="nav-link" href="/profile/">Profile</a>
      <a class="nav-link" href="/login/" onclick="logout()">Logout</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h2 class="text-center text-primary mb-4">üë©‚Äçüíº Employee Management</h2>

  <!-- üîç Search -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <input type="text" id="search-term" class="form-control w-50" placeholder="Search employee...">
    <button class="btn btn-success" id="add-employee">‚ûï Add Employee</button>
  </div>

  <!-- üßæ Table -->
  <table class="table table-striped table-bordered shadow-sm">
    <thead class="table-secondary">
      <tr>
        <th>#</th>
        <th>Form Name</th>
        <th>Data</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="employee-table"></tbody>
  </table>

  <!-- Alert box -->
  <div id="response" class="alert d-none mt-3"></div>
</div>

<!-- üß© Modal (Add/Edit Employee) -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalLabel">Add Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Select Form</label>
          <select id="form-select" class="form-select"></select>
        </div>
        <div id="dynamic-fields" class="mb-3"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="save-employee">Save Employee</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const token = localStorage.getItem('access');
const baseURL = '/api/';
let editingEmployeeId = null; // Track edit mode

// ‚úÖ Fetch all employees
async function loadEmployees() {
  try {
    const res = await axios.get(`${baseURL}employees/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    renderTable(res.data);
  } catch (err) {
    console.error(err);
    showResponse('Error loading employees', 'danger');
  }
}

// üé® Render employee list
function renderTable(data) {
  const table = document.getElementById('employee-table');
  table.innerHTML = '';
  data.forEach((emp, index) => {
    table.innerHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${emp.form_name || '‚Äî'}</td>
        <td>${formatData(emp.data)}</td>
        <td>${new Date(emp.created_at).toLocaleDateString()}</td>
        <td>
          <button class="btn btn-warning btn-sm me-1" onclick="editEmployee(${emp.id})">‚úèÔ∏è Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">üóëÔ∏è Delete</button>
        </td>
      </tr>`;
  });
}

// üßæ Format employee data object
function formatData(data) {
  return Object.entries(data)
    .map(([k, v]) => `<b>${k}</b>: ${v}`)
    .join('<br>');
}

// üóëÔ∏è Delete Employee
async function deleteEmployee(id) {
  if (!confirm('Are you sure you want to delete this employee?')) return;
  try {
    await axios.delete(`${baseURL}employees/${id}/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    showResponse('Employee deleted successfully!', 'success');
    loadEmployees();
  } catch (err) {
    showResponse('Error deleting employee', 'danger');
  }
}

// üîç Search Employee
document.getElementById('search-term').addEventListener('keyup', async (e) => {
  const term = e.target.value.toLowerCase();
  try {
    const res = await axios.get(`${baseURL}employees/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const filtered = res.data.filter(emp =>
      JSON.stringify(emp.data).toLowerCase().includes(term)
    );
    renderTable(filtered);
  } catch {
    showResponse('Error searching employees', 'danger');
  }
});

// ‚ûï Add Employee Modal
document.getElementById('add-employee').addEventListener('click', async () => {
  editingEmployeeId = null;
  document.getElementById('employeeModalLabel').innerText = 'Add Employee';
  document.getElementById('dynamic-fields').innerHTML = '';
  const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
  try {
    const res = await axios.get(`${baseURL}forms/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const formSelect = document.getElementById('form-select');
    formSelect.innerHTML = '<option value="">Select Form</option>';
    res.data.forEach(f => {
      formSelect.innerHTML += `<option value="${f.id}">${f.name}</option>`;
    });
    modal.show();
  } catch {
    showResponse('Error loading forms', 'danger');
  }
});

// üìÑ Load fields dynamically when form is selected
document.getElementById('form-select').addEventListener('change', async (e) => {
  const formId = e.target.value;
  if (!formId) return;
  await loadFormFields(formId);
});

async function loadFormFields(formId, prefillData = {}) {
  try {
    const res = await axios.get(`${baseURL}forms/${formId}/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const container = document.getElementById('dynamic-fields');
    container.innerHTML = '';
    res.data.fields.forEach(f => {
      const value = prefillData[f.label] || '';
      container.innerHTML += `
        <div class="mb-2">
          <label class="form-label">${f.label}${f.required ? ' *' : ''}</label>
          <input type="${f.field_type}" class="form-control emp-input" name="${f.label}" value="${value}" ${f.required ? 'required' : ''}>
        </div>`;
    });
  } catch {
    showResponse('Error loading form fields', 'danger');
  }
}

// üíæ Save Employee (Add/Edit) with form_name
document.getElementById('save-employee').addEventListener('click', async () => {
  const formSelect = document.getElementById('form-select');
  const formId = formSelect.value;
  const formName = formSelect.options[formSelect.selectedIndex].text; // <-- Save form name
  if (!formId) {
    showResponse('Please select a form.', 'warning');
    return;
  }

  const inputs = document.querySelectorAll('#dynamic-fields .emp-input');
  const data = {};
  inputs.forEach(i => data[i.name] = i.value);

  try {
    if (editingEmployeeId) {
      await axios.put(`${baseURL}employees/${editingEmployeeId}/`, {
        form: formId,
        form_name: formName, // <-- include form_name
        data
      }, { headers: { Authorization: `Bearer ${token}` } });
      showResponse('Employee updated successfully!', 'success');
    } else {
      await axios.post(`${baseURL}employees/`, {
        form: formId,
        form_name: formName, // <-- include form_name
        data
      }, { headers: { Authorization: `Bearer ${token}` } });
      showResponse('Employee added successfully!', 'success');
    }
    bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
    loadEmployees();
  } catch (err) {
    showResponse('Error saving employee', 'danger');
  }
});

// ‚úèÔ∏è Edit Employee
async function editEmployee(id) {
  editingEmployeeId = id;
  document.getElementById('employeeModalLabel').innerText = 'Edit Employee';
  const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
  document.getElementById('dynamic-fields').innerHTML = '';
  try {
    const empRes = await axios.get(`${baseURL}employees/${id}/`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const formId = empRes.data.form;
    await loadFormFields(formId, empRes.data.data);
    document.getElementById('form-select').value = formId;
    modal.show();
  } catch {
    showResponse('Error loading employee data', 'danger');
  }
}

// üö™ Logout
function logout() {
  localStorage.removeItem('access');
  localStorage.removeItem('refresh');
  alert('Logged out successfully!');
}

// üé® Show alert
function showResponse(msg, type) {
  const box = document.getElementById('response');
  box.className = `alert alert-${type}`;
  box.innerText = msg;
  box.classList.remove('d-none');
  setTimeout(() => box.classList.add('d-none'), 4000);
}

// üöÄ Initial load
window.onload = loadEmployees;
</script>
</body>
</html>
